<link rel="import" href="../polymer/polymer.html">
<script src='./vars.js'></script>
<dom-module id="ac-synthesizer">
    <template>
        <style></style>
    </template>
    <script>
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {},
            properties: {
                startNote:{
                    type:Number,
                    value:29
                },
                impulseUrl: {
                    type: String,
                    value: '../../bower_components/ac-synthesizer/16_IR_Pool_Size_00.wav'
                },
                notesUrl: {
                    type: String,
                    value: '/data/accordion.mp3'
                }
            },
            updateVelocity: function (velocity) {
                trebleVolume.gain.value = (velocity / 127) * 2;
            },
            _noteOffAux: function (note) {
                if (notesOffWaiting[note -this.startNote] > 0) {
                    notesOffWaiting[note -this.startNote]--;
                    this.noteOff(note);
                }
            },
            _noteOnAux: function (note) {
                if (notesOnWaiting[note -this.startNote] > 0) {
                    notesOnWaiting[note -this.startNote]--;
                    this.noteOn(note);
                }
            },
            noteOn: function (note) {
                if (noteOn[note -this.startNote] === 0) {
                    noteOn[note -this.startNote] = 1;
                    audioGains[note -this.startNote].gain.value = 1.0;
                    var timeout = Math.round(50*Math.random()) ;
                    setTimeout(this._noteOffAux(note), timeout) ;
                } else {
                    notesOnWaiting[note -this.startNote]++;
                }
            },
            noteOff: function (note) {
                if (noteOn[note -this.startNote] === 1) {
                    noteOn[note -this.startNote] = 0;
                    audioGains[note -this.startNote].gain.value = 0.0;
                    var timeout = Math.round(50*Math.random()) ;
                    setTimeout(this._noteOnAux(note), timeout) ;

                } else {
                    notesOffWaiting[note -this.startNote]++;
                }
            },
            processNotes: function (buffer) {
                var audioSource = context.createBufferSource();
                audioSource.connect(context.destination);
                context.decodeAudioData(buffer, function (res) {
                    var source = context.createBufferSource();
                    var sourceGain = context.createGain();
                    source.buffer = res;
                    source.connect(sourceGain);
                    source.loop = true;
                    sourceGain.connect(compressor);
                    sourceGain.gain.value = 0;
                    source.start();
                    audioGains.push(sourceGain);
                    notesOnWaiting.push(0);
                    notesOffWaiting.push(0);
                    noteOn.push(0);
                });
            },
            processConcatenatedFile: function (data) {
                var bb = new DataView(data);
                var offset = 0;
                while (offset < bb.byteLength) {
                    var length = bb.getUint32(offset, true);
                    offset += 4;
                    var sound = this.extractBuffer(data, offset, length);
                    offset += length;
                    this.processNotes(sound.buffer);
                }
            },
            extractBuffer: function (src, offset, length) {
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(src, offset, length);
                dstU8.set(srcU8);
                return dstU8;
            },
            ready: function () {
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', this.notesUrl, true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function () {
                    this.processConcatenatedFile(notesRequest.response);
                }.bind(this);
                var convolverRequest = new XMLHttpRequest();
                convolverRequest.open('GET', this.impulseUrl, true);
                convolverRequest.responseType = 'arraybuffer';
                convolverRequest.onload = function () {
                    context.decodeAudioData(convolverRequest.response, function (buffer) {
                        convolver.buffer = buffer;
                        // convolver.normalize = true ;
                        notesRequest.send();
                    });
                };
                convolverRequest.send();
            }
        });
    </script>
</dom-module>
