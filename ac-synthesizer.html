<link rel="import" href="../polymer/polymer.html">
<script src='./vars.js'></script>
<dom-module id="ac-synthesizer">
    <template>
        <style>
            [box] {
                position: absolute;
                top: 400px;
                width: 100px;
                height: 100px;
                background-color: red;
            }
            [box]:hover{
                cursor: pointer;
            }
        </style>
        <div box></div>
    </template>
    <script>
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {
                "click":"test"
            },
            properties: {
                impulseUrl:{
                    type:String,
                    value:'/bower_components/ac-synthesizer/factory.hall.mp3'
                },
                notesUrl:{
                    type:String,
                    value:'/data/accordion.mp3'
                }
            },
            test: function(){
                if (flag)
                    this.noteOn(97) ;
                else
                    this.noteOff(97) ;
                flag =!flag ;
            },
            updateVolume: function(velocity){
                // masterVolume.gain.value = velocity/127;
                // console.log(velocity/127);
                trebleVolume.gain.value = (velocity/127)*0.8 ;
            },
            noteOn: function (note) {
                audioGains[note-29].gain.value=  1.0;
            },
            noteOff: function (note) {
                audioGains[note-29].gain.value=  0.0;
            },
            processNotes: function (buffer) {
                var audioSource = context.createBufferSource();
                audioSource.connect(context.destination);
                context.decodeAudioData(buffer, function (res) {
                    var source = context.createBufferSource();
                    var sourceGain = context.createGain();
                    source.buffer = res;
                    source.connect(sourceGain);
                    source.loop = true;
                    trebleVolume.connect(convolver);
                    sourceGain.connect(trebleVolume);
                    sourceGain.gain.value = 0;
                    source.start() ;
                    audioGains.push(sourceGain);
                });
            },
            processConcatenatedFile: function (data) {
                var bb = new DataView(data);
                var offset = 0;
                while (offset < bb.byteLength) {
                    var length = bb.getUint32(offset, true);
                    offset += 4;
                    var sound = this.extractBuffer(data, offset, length);
                    offset += length;
                    this.processNotes(sound.buffer);
                }
            },
            extractBuffer: function (src, offset, length) {
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(src, offset, length);
                dstU8.set(srcU8);
                return dstU8;
            },
            ready: function () {
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', this.notesUrl, true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function () {
                    this.processConcatenatedFile(notesRequest.response);
                }.bind(this);
                var convolverRequest = new XMLHttpRequest();
                convolverRequest.open('GET', this.impulseUrl, true);
                convolverRequest.responseType = 'arraybuffer';
                convolverRequest.onload = function () {
                    context.decodeAudioData(convolverRequest.response, function (buffer) {
                        convolver.buffer = buffer;
                        notesRequest.send();
                    });
                };
                convolverRequest.send();
            }
        });
    </script>
</dom-module>
