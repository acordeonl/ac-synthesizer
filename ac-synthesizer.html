<link rel="import" href="../polymer/polymer.html">
<script src='./vars.js'></script>
<dom-module id="ac-synthesizer">
    <template>
        <style></style>
    </template>
    <script>
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {
                "click": "test"
            },
            properties: {
                impulseUrl: {
                    type: String,
                    value: '../../bower_components/ac-synthesizer/IRs/16_IR_Pool_Size_00.wav'
                },
                notesUrl: {
                    type: String,
                    value: '/data/accordion.mp3'
                }
            },
            test: function () {
                if (flag)
                    this.noteOn(97);
                else
                    this.noteOff(97);
                flag = !flag;
            },
            updateVelocity: function (velocity) {
                trebleVolume.gain.value = (velocity / 127) * 1;
            },
            noteOn: function (note) {
                waitingOn[note - 29]++;
                if (audioGains[note - 29].gain.value === 0.0 && !locked[note - 29]) {
                    locked[note - 29] = true;
                    audioGains[note - 29].gain.value = 1.0;
                    waitingOn[note - 29]--;
                    locked[note - 29] = false;
                    this.async(function(){
                        this._noteOffAux(note);
                    } , 5 )  ;
                }
            },
            _noteOnAux: function (note) {
                if (waitingOn[note - 29] > 0) {
                    if (audioGains[note - 29].gain.value === 0.0 && !locked[note - 29]) {
                        locked[note - 29] = true;
                        audioGains[note - 29].gain.value = 1.0;
                        waitingOn[note - 29]--;
                        locked[note - 29] = false;
                        this.async(function(){
                            this._noteOffAux(note);
                        } , 5 )  ;
                    }
                }
            },
            _noteOffAux: function (note) {
                if (waitingOff[note - 29] > 0) {
                    if (audioGains[note - 29].gain.value === 1.0 && !locked[note - 29]) {
                        locked[note - 29] = true;
                        audioGains[note - 29].gain.value = 0.0;
                        waitingOff[note - 29]--;
                        locked[note - 29] = false;
                        this.async(function(){
                            this._noteOnAux(note);
                        } , 5 )  ;
                    }
                }
            },
            noteOff: function (note) {
                waitingOff[note - 29]++;
                if (audioGains[note - 29].gain.value === 1.0 && !locked[note - 29]) {
                    locked[note - 29] = true;
                    audioGains[note - 29].gain.value = 0.0;
                    waitingOff[note - 29]--;
                    locked[note - 29] = false;
                    this.async(function(){
                        this._noteOnAux(note);
                    } , 5 )  ;
                }
            },
            processNotes: function (buffer) {
                var audioSource = context.createBufferSource();
                audioSource.connect(context.destination);
                context.decodeAudioData(buffer, function (res) {
                    var source = context.createBufferSource();
                    var sourceGain = context.createGain();
                    source.buffer = res;
                    source.connect(sourceGain);
                    source.loop = true;
                    sourceGain.connect(compressor);
                    sourceGain.gain.value = 0;
                    source.start();
                    locked.push(false);
                    waitingOffLock.push(false);
                    waitingOnLock.push(false);
                    waitingOn.push(0);
                    waitingOff.push(0);
                    audioGains.push(sourceGain);
                });
            },
            processConcatenatedFile: function (data) {
                var bb = new DataView(data);
                var offset = 0;
                while (offset < bb.byteLength) {
                    var length = bb.getUint32(offset, true);
                    offset += 4;
                    var sound = this.extractBuffer(data, offset, length);
                    offset += length;
                    this.processNotes(sound.buffer);
                }
            },
            extractBuffer: function (src, offset, length) {
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(src, offset, length);
                dstU8.set(srcU8);
                return dstU8;
            },
            ready: function () {
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', this.notesUrl, true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function () {
                    this.processConcatenatedFile(notesRequest.response);
                }.bind(this);
                var convolverRequest = new XMLHttpRequest();
                convolverRequest.open('GET', this.impulseUrl, true);
                convolverRequest.responseType = 'arraybuffer';
                convolverRequest.onload = function () {
                    context.decodeAudioData(convolverRequest.response, function (buffer) {
                        convolver.buffer = buffer;
                        // convolver.normalize = true ;
                        notesRequest.send();
                    });
                };
                convolverRequest.send();
            }
        });
    </script>
</dom-module>
