<link rel="import" href="../polymer/polymer.html">
<!-- <script src='./vars.js'></script> -->
<dom-module id="ac-synthesizer">
    <template>
        <style></style>
    </template>
    <script>
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {},
            properties: {
                impulseUrl: {
                    type: String,
                    value: '../../bower_components/ac-synthesizer/16_IR_Pool_Size_00.wav'
                },
                notesUrl: {
                    type: String
                }
            },
            updateVelocity: function (velocity) {
                this.trebleVolume.gain.value = (velocity / 127) * 2;
            },
            _noteOffAux: function (note) {
                if (this.notesOffWaiting[note] > 0) {
                    this.notesOffWaiting[note]--;
                    this.noteOff(note);
                }
            },
            _noteOnAux: function (note) {
                if (this.notesOnWaiting[note] > 0) {
                    this.notesOnWaiting[note]--;
                    this.noteOn(note);
                }
            },
            noteOn: function (note) {
                if (this.noteOnArr[note] === 0) {
                    this.noteOnArr[note] = 1;
                    this.audioGains[note].gain.value = 1.0;
                    var timeout = Math.round(50 * Math.random());
                    setTimeout(this._noteOffAux(note), timeout);
                } else {
                    this.notesOnWaiting[note]++;
                }
            },
            noteOff: function (note) {
                if (this.noteOnArr[note] === 1) {
                    this.noteOnArr[note] = 0;
                    this.audioGains[note].gain.value = 0.0;
                    var timeout = Math.round(50 * Math.random());
                    setTimeout(this._noteOnAux(note), timeout);
                } else {
                    this.notesOffWaiting[note]++;
                }
            },
            processNotes: function (buffer) {
                var audioSource = this.context.createBufferSource();
                audioSource.connect(this.context.destination);
                this.context.decodeAudioData(buffer, function (res) {
                    var source = this.context.createBufferSource();
                    var sourceGain = this.context.createGain();
                    source.buffer = res;
                    source.connect(sourceGain);
                    source.loop = true;
                    sourceGain.connect(this.compressor);
                    sourceGain.gain.value = 0;
                    source.start();
                    this.audioGains.push(sourceGain);
                    this.notesOnWaiting.push(0);
                    this.notesOffWaiting.push(0);
                    this.noteOnArr.push(0);
                }.bind(this));
            },
            processConcatenatedFile: function (data) {
                var bb = new DataView(data);
                var offset = 0;
                while (offset < bb.byteLength) {
                    var length = bb.getUint32(offset, true);
                    offset += 4;
                    var sound = this.extractBuffer(data, offset, length);
                    offset += length;
                    this.processNotes(sound.buffer);
                }
            },
            extractBuffer: function (src, offset, length) {
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(src, offset, length);
                dstU8.set(srcU8);
                return dstU8;
            },
            ready: function () {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.context = new AudioContext();
                    this.convolver = this.context.createConvolver();
                    this.dry = this.context.createGain();
                    this.wet = this.context.createGain();
                    this.compressor = this.context.createDynamicsCompressor();
                    this.compressorEnd = this.context.createDynamicsCompressor();
                    this.trebleVolume = this.context.createGain();
                    this.biquadFilter = this.context.createBiquadFilter();
                    this.audioGains = [];
                    this.notesOnWaiting = [];
                    this.notesOffWaiting = [];
                    this.noteOnArr = [];
                    this.dry.gain.value = 1.3;
                    this.wet.gain.value = 1.35;
                    this.trebleVolume.gain.value = 1;
                    this.compressor.attack = 5;
                    this.compressor.release = 5;
                    this.biquadFilter.type = "highpass";
                    this.biquadFilter.frequency.value = 0;
                    this.compressor.connect(this.trebleVolume);
                    this.trebleVolume.connect(this.dry);
                    this.trebleVolume.connect(this.convolver);
                    this.convolver.connect(this.wet);
                    this.dry.connect(this.compressorEnd);
                    this.wet.connect(this.compressorEnd);
                    this.compressorEnd.connect(this.biquadFilter);
                    this.biquadFilter.connect(this.context.destination);
                    var notesRequest = new XMLHttpRequest();
                    notesRequest.open('GET', this.notesUrl, true);
                    notesRequest.responseType = 'arraybuffer';
                    notesRequest.onload = function () {
                        this.processConcatenatedFile(notesRequest.response);
                    }.bind(this);
                    var convolverRequest = new XMLHttpRequest();
                    convolverRequest.open('GET', this.impulseUrl, true);
                    convolverRequest.responseType = 'arraybuffer';
                    convolverRequest.onload = function () {
                        this.context.decodeAudioData(convolverRequest.response, function (buffer) {
                            this.convolver.buffer = buffer;
                            // this.convolver.normalize = true ;
                            notesRequest.send();
                        }.bind(this));
                    }.bind(this);
                    convolverRequest.send();
                });
            }
        });
    </script>
</dom-module>
