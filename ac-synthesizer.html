<link rel="import" href="../polymer/polymer.html">
<dom-module id="ac-synthesizer">
    <template>
        <style></style>
    </template>
    <script>
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {},
            properties: {
                instrumentVelocity:{
                    type:Number,
                    value:1,
                    observer:'_updateInstrumentVolume'
                },
                instrumentGain:{
                    type:Number,
                    value:1,
                    observer:'_updateInstrumentVolume'
                },
                playbackGain:{
                    type:Number,
                    value:1,
                    observer:'_updatePlaybackVolume'
                },
                instrumentSynthGain:{
                    type:Object
                },
                playbackSynthGain:{
                    type:Object
                },
                id:{
                    reflectToAttribute:true,
                    type:String
                },
                instrumentUrl: {
                    type: String
                },
                notesBuffers:{
                    type:Array,
                    value:[]
                },
                loopDurations:{
                    type:Array,
                    value:[]
                },
                playbackButtonAudio:{
                    type:Array,
                    value:[]
                },
                instrumentButtonAudio:{
                    type:Array,
                    value:[]
                },
                requested:{
                    type:Array,
                    value:[]
                }
            },
            _loadNote: function(note){
                if(this.requested[this.instrumentUrl+note]!==undefined)
                    return ;
                this.requested[this.instrumentUrl+note] =true ;
                var request = new XMLHttpRequest();
                request.instrumentUrl = this.instrumentUrl;
                request.note = note ;
                request.open('GET', request.instrumentUrl+'/'+request.note+'c.mp3', true);
                request.responseType = 'arraybuffer';
                request.onload = this._onload.bind(this) ;
                request.send();
            },
            _onload: function(request){
                request = request.currentTarget ;
                if (request.status === 404) {
                    if (!noteNotFound) {
                        this.fire("toast", {msg: 'La tonalidad no pudo ser cargada'});
                        noteNotFound = true;
                    }
                    return;
                }
                var data = request.response;
                var bb = new DataView(data);
                this.loopDurations[request.instrumentUrl+request.note] = bb.getFloat32(0, true);
                var length = bb.getUint32(4, true);
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(data, 8, length);
                dstU8.set(srcU8);
                var sound = dstU8;
                context.decodeAudioData(sound.buffer, function (buffer) {
                    this.notesBuffers[request.instrumentUrl+request.note] = buffer ;
                }.bind(this));
            },
            _startButtonAudio: function(note,button,e){
                var source = context.createBufferSource();
                source.buffer = this.notesBuffers[this.instrumentUrl+note] ;
                source.loopStart = source.buffer.duration - this.loopDurations[this.instrumentUrl+note];
                source.loopEnd = source.buffer.duration;
                sourceGain = context.createGain();
                source.connect(sourceGain);
                source.loop = true;
                if(e.detail.origin === 'instrument'){
                    sourceGain.connect(this.instrumentSynthGain);
                    this.instrumentSynthGain.connect(compressor) ;
                }
                else {
                    sourceGain.connect(this.playbackSynthGain);
                    this.playbackSynthGain.connect(compressor) ;
                }
                source.start(e.detail.time);
                var audio = {} ;
                audio.source =  source ;
                audio.gain =  sourceGain ;
                if(e.detail.origin ==='playback')
                    this.playbackButtonAudio[this.instrumentUrl+button] = audio ;
                if(e.detail.origin ==='instrument')
                    this.instrumentButtonAudio[this.instrumentUrl+button] = audio ;
            },
            _stopButtonAudio: function(button,e){
                var audio ;
                if(e.detail.origin==='playback')
                    audio = this.playbackButtonAudio[this.instrumentUrl+button] ;
                if(e.detail.origin==='instrument')
                    audio = this.instrumentButtonAudio[this.instrumentUrl+button] ;
                audio.gain.gain.setTargetAtTime(0,e.detail.time, 0.008) ;
                audio.source.stop(e.detail.time+0.1) ;
            },
            _updateInstrumentVolume: function(){
                if(!this.instrumentSynthGain)
                    this.instrumentSynthGain = context.createGain() ;
                if(this.instrumentGain !==undefined && this.instrumentVelocity!==undefined) {
                    this.instrumentSynthGain.gain.value = this.instrumentGain*this.instrumentVelocity ;
                }
            },
            _updatePlaybackVolume: function(){
                if(!this.playbackSynthGain)
                    this.playbackSynthGain = context.createGain() ;
                if(this.playbackGain !==undefined) {
                    this.playbackSynthGain.gain.value = this.playbackGain;
                }
            },
            ready: function () {
                if(!this.instrumentSynthGain) {
                    this.instrumentSynthGain = context.createGain() ;
                    this.instrumentSynthGain.gain.value = 1;
                }
            }
        });
    </script>
</dom-module>
