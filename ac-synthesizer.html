d<link rel="import" href="../polymer/polymer.html">
<script src='./vars.js'></script>
<dom-module id="ac-synthesizer">
    <template>
        <style>
            [box] {
                position: absolute;
                top: 400px;
                width: 100px;
                height: 100px;
                background-color: red;
            }
        </style>
        <div box></div>
    </template>
    <script>
        var context = new AudioContext();
        var masterCompression = context.createDynamicsCompressor();
        var convolver = context.createConvolver();
        var convolverGain = context.createGain();
        var masterGain = context.createGain();
        convolverGain.gain.value = 1;
        masterGain.gain.value = 1;
        var audioSources = [];
        var midiNotes = [];
        var note = 29;
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {
                "click": "_stop"
            },
            properties: {},
            _stop: function () {
                for (var i = 0; i < audioSources.length; i++) {
                    audioSources[i].stop();
                }
            },
            
            createSoundWithBuffer: function (buffer) {
                var audioSource = context.createBufferSource();
                audioSource.connect(context.destination);
                context.decodeAudioData(buffer, function (res) {
                    var source = context.createBufferSource();
                    source.buffer = res;
                    source.connect(convolverGain);
                    source.connect(masterGain);
                    convolverGain.connect(convolver);
                    masterGain.connect(masterCompression);
                    masterCompression.connect(context.destination);
                    if (this.time === undefined)
                        this.time = 0;
                    source.start(5 + this.time);
                    this.time = this.time + 0.75;
                    audioSources.push(source);
                    midiNotes.push(note++);
                });
            },
            processConcatenatedFile: function (data) {
                var bb = new DataView(data);
                var offset = 0;
                while (offset < bb.byteLength) {
                    var length = bb.getUint32(offset, true);
                    offset += 4;
                    var sound = this.extractBuffer(data, offset, length);
                    offset += length;
                    this.createSoundWithBuffer(sound.buffer);
                }
            },
            extractBuffer: function (src, offset, length) {
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(src, offset, length);
                dstU8.set(srcU8);
                return dstU8;
            },
            ready: function () {
                this.time = 0;
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', '/data/accordion.mp3', true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function () {
                    this.processConcatenatedFile(notesRequest.response);
                }.bind(this);
                var convolverRequest = new XMLHttpRequest();
                convolverRequest.open('GET', 'https://dl.dropboxusercontent.com/s/v3hwaojdxrono5t/factory.hall.wav?dl=0', true);
                convolverRequest.responseType = 'arraybuffer';
                convolverRequest.onload = function () {
                    context.decodeAudioData(convolverRequest.response, function (buffer) {
                        convolver.buffer = buffer;
                        convolver.connect(masterGain);
                        notesRequest.send();
                    });
                };
                convolverRequest.send() ;
                // this.loadAudio("https://dl.dropboxusercontent.com/s/bwlqwxhfoaaerx1/65l.mp3?dl=0");
            }
        });
    </script>
</dom-module>
