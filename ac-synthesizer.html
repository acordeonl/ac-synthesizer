<link rel="import" href="../polymer/polymer.html">

<dom-module id="ac-synthesizer">
    <template>
        <style></style>
    </template>
    <script>
        Polymer({
            is: "ac-synthesizer",
            observers: [],
            behaviors: [],
            listeners: {},
            properties: {
                instrumentVelocity:{
                    type:Number,
                    value:1
                },
                instrumentGain:{
                    type:Number,
                    value:1
                },
                playbackGain:{
                    type:Number,
                    value:1
                },
                instrumentPanner:{
                    type:Object
                },
                playbackPanner:{
                    type:Object
                },
                instrumentSynthGain:{
                    type:Object
                },
                playbackSynthGain:{
                    type:Object
                },
                id:{
                    reflectToAttribute:true,
                    type:String
                },
                instrumentUrl: {
                    type: String
                },
                notesLoaded:{
                    type:Number,
                    value:0
                },
                instrumentNotes:{
                    type:Number
                },

                activePlayback:{
                    type:Array,
                    value:[]
                },
                activeInstrument:{
                    type:Array,
                    value:[]
                },
                notesBuffers:{
                    type:Array,
                    value:[]
                },
                loopDurations:{
                    type:Array,
                    value:[]
                },
                playbackButtonAudio:{
                    type:Array,
                    value:[]
                },
                instrumentButtonAudio:{
                    type:Array,
                    value:[]
                },
                requested:{
                    type:Array,
                    value:[]
                },
                playbackEndTimestamps:{
                    type:Array,
                    value:[]
                },
                instrumentEndTimestamps:{
                    type:Array,
                    value:[]
                }
            },
            loadNote: function(note,id){
                if(this.requested[note]!==undefined) {
                    if(this.notesLoaded === undefined )
                        this.notesLoaded = 0 ;
                    this.notesLoaded ++ ;
                    if(this.notesLoaded === this.instrumentNotes ) {
                        this.fire('notes-loaded') ;
                    }
                    return ;
                }
                var request = new XMLHttpRequest();
                request.id = id ;
                request.note = note ;
                request.open('GET', this.instrumentUrl+'/'+request.note+'c.mp3', true);
                request.responseType = 'arraybuffer';
                request.onload = this._onload.bind(this) ;
                request.send();
            },
            _onload: function(request){
                request = request.currentTarget ;
                if (request.status === 404) {
                    if (!noteNotFound) {
                        this.fire("toast", {msg: 'La tonalidad no pudo ser cargada'});
                        noteNotFound = true;
                    }
                    return;
                }
                var data = request.response;
                var bb = new DataView(data);
                this.requested[request.note] =true ;
                this.loopDurations[request.note] = bb.getFloat32(0, true);
                var length = bb.getUint32(4, true);
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(data, 8, length);
                dstU8.set(srcU8);
                var sound = dstU8;
                context.decodeAudioData(sound.buffer, function (buffer) {
                    this.notesBuffers[request.note] = buffer ;
                    if(this.notesLoaded === undefined )
                        this.notesLoaded = 0 ;
                    this.notesLoaded ++ ;
                    if(this.notesLoaded === this.instrumentNotes ) {
                        this.fire('notes-loaded') ;
                    }
                }.bind(this));
            },
            setPlaybackGain: function(gain){
                this.playbackGain = gain ;
                this._updatePlaybackVolume() ;
            },
            setInstrumentGain: function(gain){
                this.instrumentGain = gain ;
                this._updateInstrumentVolume() ;
            },
            setVelocity: function(velocity){
                this.instrumentVelocity = velocity ;
                this._updateInstrumentVolume() ;
            },
            setPlaybackPanning: function(value){
                this.playbackPanner.pan.value = value ;
            },
            setInstrumentPanning: function(value){
                this.instrumentPanner.pan.value = value ;
            },
            _startButtonAudio: function(note,button,e){
                if(e.detail.origin==='playbackGUI')
                    return ;
                synthBuffer ++ ;
                if(synthBuffer > synthBufferLen)
                    synthBuffer = synthBufferLen ;

                var audio = {};
                var sourceGain = context.createGain();
                var source = context.createBufferSource();
                var when ;
                if(e.detail.playNow !== undefined) {
                    when = context.currentTime ;
                }
                else{
                    var playBackTime = e.detail.playedTime + (context.currentTime-e.detail.playTime)/(e.detail.tempo) ;
                    when =  context.currentTime+(e.detail.tempo)*(e.detail.time-playBackTime)  ;
                }
                source.buffer = this.notesBuffers[note] ;
                source.loopStart = source.buffer.duration - this.loopDurations[note];
                source.loopEnd = source.buffer.duration;
                sourceGain.gain.value = 0.7 ;
                source.connect(sourceGain);
                source.loop = true;
                source.start(when);
                audio.gain = sourceGain ;
                audio.source = source ;
                if(e.detail.origin ==='playback') {
                    audio.gain.connect(this.playbackSynthGain) ;
                    this.playbackButtonAudio[button] = audio ;
                    this.activePlayback.push(audio);
                }
                if(e.detail.origin ==='instrument') {
                    audio.gain.connect(this.instrumentSynthGain) ;
                    this.instrumentButtonAudio[button] = audio ;
                    this.activeInstrument.push(audio) ;
                }
                source = null ;
                sourceGain = null ;
                when = null ;
                audio = null ;
            },
            _stopButtonAudio: function(button,e){
                if(e.detail.origin==='playbackGUI')
                    return ;
                var audio  ;

                var playBackTime = e.detail.playedTime + (context.currentTime-e.detail.playTime)/(e.detail.tempo) ;
                var when =  context.currentTime+(e.detail.tempo)*(e.detail.time-playBackTime)  ;

                if(e.detail.origin === 'instrument')
                    audio = this.instrumentButtonAudio[button] ;
                if(e.detail.origin==='playback')
                    audio = this.playbackButtonAudio[button] ;
                if(audio === undefined || audio === null )
                    return ;
                audio.gain.gain.cancelScheduledValues(when) ;
                audio.gain.gain.setValueAtTime(audio.gain.gain.value, when);
                audio.gain.gain.exponentialRampToValueAtTime(0.00001, when+0.1);
                audio.source.stop(when+0.1) ;
                audio.source.onended = function(){
                    synthBuffer -- ;
                    if(synthBuffer < 0 )
                        synthBuffer = 0 ;
                } ;
                var i ;
                if(e.detail.origin ==='playback'){
                    this.playbackEndTimestamps.push(when+4) ;
                    for (i = 0; i < this.playbackEndTimestamps.length && this.playbackEndTimestamps[i]<context.currentTime; i++);
                    this.playbackEndTimestamps.splice(0,i);
                    this.activePlayback.splice(0,i) ;
                }
                if(e.detail.origin === 'instrument') {
                    this.instrumentEndTimestamps.push(when+4) ;
                    for (i = 0; i < this.instrumentEndTimestamps.length && this.instrumentEndTimestamps[i]<context.currentTime; i++);
                    this.instrumentEndTimestamps.splice(0,i);
                    this.activeInstrument.splice(0,i) ;
                }
                audio = null ;
                when = null ;
            },
            stop: function(origin){
                var audio;
                synthBuffer = 0 ;
                if(origin==='playback') {
                    this.playbackEndTimestamps = [] ;
                    while (this.activePlayback.length > 0) {
                        audio = this.activePlayback[this.activePlayback.length - 1];
                        if(audio === null || audio === undefined)
                            continue ;
                        audio.gain.gain.cancelScheduledValues(context.currentTime) ;
                        audio.gain.gain.setValueAtTime(audio.gain.gain.value, context.currentTime);
                        audio.gain.gain.exponentialRampToValueAtTime(0.00001, context.currentTime+0.1);
                        audio.source.stop(context.currentTime+0.1) ;
                        this.activePlayback.pop();
                    }
                }
                else if( origin==='instrument') {
                    this.instrumentEndTimestamps = [] ;
                    while (this.activeInstrument.length > 0) {
                        audio = this.activeInstrument[this.activeInstrument.length - 1];
                        if(audio === null || audio === undefined)
                            continue ;
                        audio.gain.gain.cancelScheduledValues(context.currentTime) ;
                        audio.gain.gain.setValueAtTime(audio.gain.gain.value, context.currentTime);
                        audio.gain.gain.exponentialRampToValueAtTime(0.00001, context.currentTime+0.1);
                        audio.source.stop(context.currentTime+0.1) ;
                        this.activeInstrument.pop();
                    }
                }
            },
            _updateInstrumentVolume: function(){
                if(!this.instrumentSynthGain)
                    this.instrumentSynthGain = context.createGain() ;
                if(!this.instrumentPanner)
                    this.instrumentPanner = context.createStereoPanner() ;
                if(this.instrumentGain !==undefined && this.instrumentVelocity!==undefined) {
                    this.instrumentSynthGain.gain.value = this.instrumentGain*this.instrumentVelocity ;
                }
                this.instrumentSynthGain.connect(this.instrumentPanner);
                this.instrumentPanner.connect(context.destination);
            },
            _updatePlaybackVolume: function(){
                if(!this.playbackSynthGain)
                    this.playbackSynthGain = context.createGain() ;
                if(!this.playbackPanner)
                    this.playbackPanner = context.createStereoPanner() ;
                if(this.playbackGain !==undefined) {
                    this.playbackSynthGain.gain.value = this.playbackGain;
                }
                this.playbackSynthGain.connect(this.playbackPanner);
                this.playbackPanner.connect(context.destination);
            },
            ready: function () {
                this.playbackEndTimestamps =[] ;
                this.instrumentEndTimestamps =[] ;
                this.requested = [] ;
                this.loopDurations = [] ;
                this.notesBuffers = [] ;
                this.playbackButtonAudio = [] ;
                this.instrumentButtonAudio = []  ;
                this.activeInstrument = []  ;
                this.activePlayback = []  ;
                if(!this.instrumentSynthGain)
                    this.instrumentSynthGain = context.createGain() ;
                if(!this.playbackSynthGain)
                    this.playbackSynthGain = context.createGain() ;
                if(!this.instrumentPanner)
                    this.instrumentPanner = context.createStereoPanner() ;
                if(!this.playbackPanner) {
                    this.playbackPanner = context.createStereoPanner() ;
                }
            }
        });
    </script>
</dom-module>
